#!/bin/bash

# 2014 Jon Suderman
# https://github.com/suderman/local

# Open a terminal and run this command:
# curl https://raw.github.com/suderman/local/master/bin/init | sh

msg() { printf "\e[0;32m=> \e[0;37m$1\e[0m\n"; }
msg-nl() { printf "\n\e[0;32m=> \e[0;37m$1\e[0m\n"; }
msg-install() { printf "\n\e[0;32m=> \e[0;37mInstalling \e[0;36m$1\e[0;37m...\e[0m\n"; }
msg-ask() { 
  if [ "$answer" == "y" ]; then msg-install $1;
  else
    printf "\n\e[0;32m=> \e[0;37mDo you want to install \e[0;36m$1\e[0;37m on this computer?\e[0m" 
    read -p " y/[n] " -n 1 -r; echo
    [[ $REPLY =~ ^[Yy]$ ]]
    if [ ! $? -ne 0 ]; then return 0; else return 1; fi
  fi
}

# Don't ask questions, just install/update everything 
answer="ask"; if [ "$1" == "y" ]; then answer="y"; fi


# What I need to get going
# ------------------------

# Install script starts here!
msg-nl "Keeping this computer up to snuff..."

# Ensure git & git-clone-pull exists
msg-install "git and git-clone-pull"
curl -sS git-clone-pull.suderman.io/install | sh

# Git clone/pull this repo to the home directory
msg-install "~/.local"
git clone-pull https://github.com/suderman/local.git ~/.local

# Don't install this on just any system
if msg-ask "~/.local/secret"; then 

  # Secret repo contains SSH and other sensitive config
  msg-install "~/.local/secret"
  git clone-pull https://github.com/suderman/secret.git ~/.local/secret

  # Update remote origins to use SSH
  msg "Updating remote origins for ~/.local and ~/.local/secret to use SSH"
  cd ~/.local && git remote set-url origin git@github.com:suderman/local.git
  cd ~/.local/secret && git remote set-url origin git@github.com:suderman/secret.git
fi

# Install rcm to manage the dotfiles
msg-install "rcm"
curl -sS install.suderman.io/rcm | sh

# Ensure the .rcrc file exists before rcup is run at all
msg "Symlinking ~/.rcrc and running rcup"
ln -sf ~/.local/dotfiles/rcrc ~/.rcrc
rcup

# Install antigen
msg-install "~/.antigen"
git clone-pull https://github.com/zsh-users/antigen.git ~/.antigen

# Install oh-my-zsh
msg-install "~/.oh-my-zsh"
git clone-pull https://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh

# Install tmuxifier
msg-install "~/.tmuxifier"
git clone-pull https://github.com/jimeh/tmuxifier.git ~/.tmuxifier

# Ensure environment variables are set
msg "Sourcing environment variables"
source $HOME/.local/zsh/platform.zsh
source $HOME/.local/zsh/path.zsh
source $HOME/.local/zsh/env.zsh

# Install sshconfig to manage ~/.ssh/config
msg-install "sshconfig"
curl -sS sshconfig.suderman.io/install | sh
msg "Running sshconfig"
sshconfig

msg-nl "...init complete!"

# Run update only if this script is called direct
if [ "$2" != "skip-update" ]; then update "$answer" skip-init; fi

